name: Sync Maps to WorkAdventure

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'maps/**/*.tmj'
      - 'maps/**/*.json'
  workflow_dispatch:

env:
  GITHUB_PAGES_BASE_URL: https://pulumamidi-harsha.github.io/work-adventure-map/maps
  MAPSTORAGE_USER: admin
  MAPSTORAGE_PASSWORD: admin123

jobs:
  discover-maps:
    name: Discover Maps
    runs-on: ubuntu-latest
    outputs:
      maps: ${{ steps.find-maps.outputs.maps }}
      map-count: ${{ steps.find-maps.outputs.count }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Find all map files
        id: find-maps
        run: |
          cd maps
          MAPS_JSON=$(find . -name "*.tmj" -type f -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
          MAP_COUNT=$(echo "$MAPS_JSON" | jq 'length')
          
          echo "maps=$MAPS_JSON" >> $GITHUB_OUTPUT
          echo "count=$MAP_COUNT" >> $GITHUB_OUTPUT
          
          echo "Found $MAP_COUNT maps:"
          echo "$MAPS_JSON" | jq -r '.[]'

  sync-to-dev:
    name: Sync to Dev Environment
    runs-on: ubuntu-latest
    needs: discover-maps
    if: needs.discover-maps.outputs.map-count > 0
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Wait for GitHub Pages Deployment
        run: |
          echo "‚è≥ Waiting 5 minutes for GitHub Pages to fully deploy..."
          echo "This ensures all maps are published before syncing to MapStorage"
          sleep 300
      
      - name: Sync maps to Dev
        env:
          MAPS: ${{ needs.discover-maps.outputs.maps }}
        run: |
          #!/bin/bash
          set -e
          
          MAPSTORAGE_API_URL="https://workadventure.dev.dso-os.int.bayer.com/map-storage"
          MAPSTORAGE_AUTH="$MAPSTORAGE_USER:$MAPSTORAGE_PASSWORD"
          
          echo "========================================="
          echo "üöÄ WorkAdventure Map Sync - DEV"
          echo "========================================="
          
          echo "üìã Fetching existing maps..."
          EXISTING_MAPS=$(curl -s -u "$MAPSTORAGE_AUTH" "$MAPSTORAGE_API_URL/maps" || echo '{"maps":{}}')
          EXISTING_COUNT=$(echo "$EXISTING_MAPS" | jq '.maps | length')
          echo "Found $EXISTING_COUNT existing maps"
          echo ""
          
          SUCCESS_COUNT=0
          SKIP_COUNT=0
          ERROR_COUNT=0
          
          echo "$MAPS" | jq -r '.[]' | while read -r MAP_FILE; do
              WAM_NAME=$(echo "$MAP_FILE" | sed 's/ /-/g' | sed 's/[()]//g' | sed 's/&/and/g' | sed 's/.tmj$/.wam/')
              MAP_URL="${GITHUB_PAGES_BASE_URL}/${MAP_FILE}"
              
              echo "üìç Processing: $MAP_FILE ‚Üí $WAM_NAME"
              
              if echo "$EXISTING_MAPS" | jq -e ".maps.\"$WAM_NAME\"" > /dev/null 2>&1; then
                  echo "   ‚è≠Ô∏è  SKIP: Already exists"
                  SKIP_COUNT=$((SKIP_COUNT + 1))
              else
                  WAM_CONTENT=$(cat <<EOF
          {
            "version": "1.0",
            "mapUrl": "$MAP_URL",
            "entities": {},
            "areas": [],
            "entityCollections": []
          }
          EOF
          )
                  
                  RESPONSE=$(curl -s -u "$MAPSTORAGE_AUTH" \
                      -X PUT \
                      -H "Content-Type: application/json" \
                      -d "$WAM_CONTENT" \
                      "$MAPSTORAGE_API_URL/$WAM_NAME" \
                      2>&1)
                  
                  if echo "$RESPONSE" | grep -q "successfully uploaded"; then
                      echo "   ‚úÖ SUCCESS"
                      SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                  else
                      echo "   ‚ùå ERROR: $RESPONSE"
                      ERROR_COUNT=$((ERROR_COUNT + 1))
                  fi
              fi
          done
          
          echo ""
          echo "========================================="
          echo "‚ú® Dev Sync Complete!"
          echo "========================================="
          echo "‚úÖ Successfully added: $SUCCESS_COUNT"
          echo "‚è≠Ô∏è  Skipped: $SKIP_COUNT"
          echo "‚ùå Errors: $ERROR_COUNT"
          echo ""
          echo "üîó View maps at: https://workadventure.dev.dso-os.int.bayer.com/map-storage/ui/maps"

  sync-to-staging:
    name: Sync to Staging Environment
    runs-on: ubuntu-latest
    needs: [discover-maps, sync-to-dev]
    if: needs.discover-maps.outputs.map-count > 0
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Sync maps to Staging
        env:
          MAPS: ${{ needs.discover-maps.outputs.maps }}
        run: |
          #!/bin/bash
          set -e
          
          MAPSTORAGE_API_URL="https://workadventure.staging.dso-os.int.bayer.com/map-storage"
          MAPSTORAGE_AUTH="$MAPSTORAGE_USER:$MAPSTORAGE_PASSWORD"
          
          echo "========================================="
          echo "üöÄ WorkAdventure Map Sync - STAGING"
          echo "========================================="
          
          echo "üìã Fetching existing maps..."
          EXISTING_MAPS=$(curl -s -u "$MAPSTORAGE_AUTH" "$MAPSTORAGE_API_URL/maps" || echo '{"maps":{}}')
          EXISTING_COUNT=$(echo "$EXISTING_MAPS" | jq '.maps | length')
          echo "Found $EXISTING_COUNT existing maps"
          echo ""
          
          SUCCESS_COUNT=0
          SKIP_COUNT=0
          ERROR_COUNT=0
          
          echo "$MAPS" | jq -r '.[]' | while read -r MAP_FILE; do
              WAM_NAME=$(echo "$MAP_FILE" | sed 's/ /-/g' | sed 's/[()]//g' | sed 's/&/and/g' | sed 's/.tmj$/.wam/')
              MAP_URL="${GITHUB_PAGES_BASE_URL}/${MAP_FILE}"
              
              echo "üìç Processing: $MAP_FILE ‚Üí $WAM_NAME"
              
              if echo "$EXISTING_MAPS" | jq -e ".maps.\"$WAM_NAME\"" > /dev/null 2>&1; then
                  echo "   ‚è≠Ô∏è  SKIP: Already exists"
                  SKIP_COUNT=$((SKIP_COUNT + 1))
              else
                  WAM_CONTENT=$(cat <<EOF
          {
            "version": "1.0",
            "mapUrl": "$MAP_URL",
            "entities": {},
            "areas": [],
            "entityCollections": []
          }
          EOF
          )
                  
                  RESPONSE=$(curl -s -u "$MAPSTORAGE_AUTH" \
                      -X PUT \
                      -H "Content-Type: application/json" \
                      -d "$WAM_CONTENT" \
                      "$MAPSTORAGE_API_URL/$WAM_NAME" \
                      2>&1)
                  
                  if echo "$RESPONSE" | grep -q "successfully uploaded"; then
                      echo "   ‚úÖ SUCCESS"
                      SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                  else
                      echo "   ‚ùå ERROR: $RESPONSE"
                      ERROR_COUNT=$((ERROR_COUNT + 1))
                  fi
              fi
          done
          
          echo ""
          echo "========================================="
          echo "‚ú® Staging Sync Complete!"
          echo "========================================="
          echo "‚úÖ Successfully added: $SUCCESS_COUNT"
          echo "‚è≠Ô∏è  Skipped: $SKIP_COUNT"
          echo "‚ùå Errors: $ERROR_COUNT"
          echo ""
          echo "üîó View maps at: https://workadventure.staging.dso-os.int.bayer.com/map-storage/ui/maps"

  notify-completion:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [discover-maps, sync-to-dev, sync-to-staging]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "========================================="
          echo "üéâ WorkAdventure Map Sync Complete"
          echo "========================================="
          echo "Total maps discovered: ${{ needs.discover-maps.outputs.map-count }}"
          echo ""
          echo "Dev Status: ${{ needs.sync-to-dev.result }}"
          echo "Staging Status: ${{ needs.sync-to-staging.result }}"
          echo ""
          echo "All maps are now available in both environments!"
